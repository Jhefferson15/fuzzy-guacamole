<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bujo Tracker Pro v2</title>
    <link rel="icon" href="https://raw.githubusercontent.com/Jhefferson15/fuzzy-guacamole/refs/heads/main/bujo_01_capa.png" type="image/png">
    <style>
        /* --- Importações e Reset --- */
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Poppins:wght@300;400;600&family=Roboto+Mono:wght@400&display=swap');

        :root {
            --theme-primary-green: #33ff33;
            --theme-dark-green: #0A2A0A;
            --theme-medium-green: #2a5c2a;
            --theme-light-green: #6EBF6E;
            --page-bg: #1a1d1a;
            --content-bg: #242824;
            --text-color: #E0E0E0;
            --text-muted-color: #9e9e9e;
            --border-color: #3a3f3a;
            --accent-color: var(--theme-primary-green);
            --completed-color: var(--theme-primary-green);
            --dot-color: var(--theme-primary-green);
            --shadow-color: rgba(51, 255, 51, 0.2);
            --shadow-strong: 0 8px 30px rgba(0,0,0,0.5);
            --container-shadow: 0 0 0 1px var(--border-color), var(--shadow-strong);
            --btn-primary-bg: var(--theme-medium-green);
            --btn-primary-hover-bg: var(--theme-light-green);
            --btn-danger-bg: #5c2a2a;
            --btn-danger-hover-bg: #8e4444;
        }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--page-bg);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .bujo-container {
            width: 100%;
            max-width: 950px;
            height: calc(100% - 40px);
            max-height: 800px;
            background-color: var(--content-bg);
            border: 1px solid var(--border-color);
            box-shadow: var(--container-shadow);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- Cabeçalho --- */
        .bujo-header {
            padding: 18px 25px;
            background: linear-gradient(135deg, var(--theme-dark-green), #1a3a1a);
            color: var(--text-color);
            border-bottom: 2px solid var(--theme-primary-green);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            position: relative;
        }
        .bujo-header h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.8em;
            color: var(--theme-primary-green);
            text-shadow: 0 0 5px var(--theme-primary-green), 0 0 10px var(--theme-primary-green);
        }
        .sync-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8em;
            color: var(--text-muted-color);
            transition: color 0.3s ease;
        }
        .sync-status.syncing { color: var(--accent-color); }
        .sync-status-icon { width: 18px; height: 18px; }
        .sync-status-icon.spinning { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* --- Controles --- */
        .bujo-controls {
            padding: 15px 25px;
            display: flex;
            gap: 15px;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            background-color: rgba(0,0,0,0.1);
            flex-wrap: wrap;
            flex-shrink: 0;
        }
        .bujo-controls .control-group { display: flex; gap: 10px; }
        .bujo-controls button, .bujo-controls select {
            padding: 10px 18px;
            background-color: var(--btn-primary-bg);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .bujo-controls button:hover, .bujo-controls select:hover { background-color: var(--btn-primary-hover-bg); transform: translateY(-1px); }
        .month-navigation { display: flex; align-items: center; }
        .month-navigation button { background: transparent; border: 1px solid var(--border-color); padding: 8px; }
        #current-month-year { font-size: 1.1em; font-weight: 600; min-width: 160px; text-align: center; }

        /* --- Área Principal --- */
        .bujo-main {
            flex-grow: 1;
            padding: 10px 15px;
            overflow-y: auto;
        }
        #habit-tracker-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }
        #habit-tracker-table thead th {
            position: sticky;
            top: 0;
            background-color: var(--content-bg);
            z-index: 10;
            padding: 10px 5px;
            font-size: 0.8em;
            color: var(--text-muted-color);
        }
        #habit-tracker-table th.habit-name-col { width: 220px; text-align: left; padding-left: 15px; }

        .habit-row { transition: background-color 0.2s ease; }
        .habit-row.dragging { opacity: 0.5; background-color: var(--theme-medium-green); }
        .habit-row.drag-over { border-bottom: 2px solid var(--accent-color); }
        
        .habit-name-cell {
            text-align: left;
            padding: 12px 15px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: grab;
        }
        .habit-row:active .habit-name-cell { cursor: grabbing; }

        .habit-info .habit-name { font-size: 1.05em; }
        .habit-info .habit-time { font-family: 'Roboto Mono', monospace; font-size: 0.85em; color: var(--text-muted-color); }
        .habit-icon { font-size: 1.5em; flex-shrink: 0; width: 24px; text-align: center; color: var(--accent-color); }
        .habit-actions { margin-left: auto; display: flex; gap: 8px; }
        .habit-actions button { background: transparent; border: none; color: var(--text-muted-color); cursor: pointer; padding: 5px; border-radius: 50%; }
        .habit-actions button:hover { background-color: rgba(255,255,255,0.1); color: var(--text-color); }
        
        .day-cell {
            text-align: center;
            padding: 0;
            border-left: 1px solid var(--border-color);
        }
        .day-cell-inner {
            width: 100%; height: 45px;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .day-cell-inner:hover { transform: scale(1.15); background-color: var(--theme-medium-green); border-radius: 4px; z-index: 5; }
        .day-cell-inner.completed { background-color: var(--accent-color); color: var(--theme-dark-green); font-weight: bold; font-size: 1.4em; }

        /* --- Modal --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.7);
            display: flex; justify-content: center; align-items: center;
            z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.open { opacity: 1; visibility: visible; }
        .modal-content {
            background-color: var(--content-bg);
            border: 1px solid var(--border-color);
            padding: 25px 30px; border-radius: 12px;
            width: 90%; max-width: 480px;
            box-shadow: var(--shadow-strong);
            transform: scale(0.95); transition: transform 0.3s ease;
        }
        .modal-overlay.open .modal-content { transform: scale(1); }
        .modal-content h2 { margin-top: 0; margin-bottom: 25px; font-family: 'Orbitron'; color: var(--accent-color); text-align: center;}
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: 500; margin-bottom: 8px; font-size: 0.9em; }
        .form-group input {
            width: 100%; padding: 12px; border: 1px solid var(--border-color);
            border-radius: 6px; font-size: 1em; background-color: var(--page-bg);
            color: var(--text-color); transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-group input:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 3px var(--shadow-color); }
        
        .icon-picker { display: grid; grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); gap: 10px; max-height: 150px; overflow-y: auto; padding: 10px; background-color: var(--page-bg); border-radius: 6px;}
        .icon-option { font-size: 1.5em; cursor: pointer; text-align: center; padding: 5px; border-radius: 4px; transition: background-color 0.2s; }
        .icon-option:hover { background-color: var(--theme-medium-green); }
        .icon-option.selected { background-color: var(--accent-color); color: var(--theme-dark-green); }

        .modal-actions { margin-top: 30px; display: flex; justify-content: flex-end; gap: 15px; }
        .modal-actions button { padding: 12px 25px; }
        .modal-actions #delete-habit-btn { background-color: var(--btn-danger-bg); }
        .modal-actions #delete-habit-btn:hover { background-color: var(--btn-danger-hover-bg); }

        /* --- Outros --- */
        .hidden { display: none !important; }
        .no-habits-message { text-align: center; padding: 60px 20px; font-size: 1.1em; color: var(--text-muted-color); }
    </style>
</head>
<body>

    <div class="bujo-container">
        <header class="bujo-header">
            <h1>Habit Tracker</h1>
            <div id="sync-status" class="sync-status" title="Status da Sincronização">
                <span id="sync-status-text">Pronto</span>
                <svg id="sync-status-icon" class="sync-status-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
            </div>
        </header>

        <div class="bujo-controls">
            <button id="add-habit-modal-btn" title="Adicionar Novo Hábito">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v-2z"/></svg>
                Adicionar
            </button>
            <div class="control-group">
                <label for="sort-by" style="display: flex; align-items: center; font-size: 0.9em;">Ordenar:</label>
                <select id="sort-by">
                    <option value="manual">Manual</option>
                    <option value="time">Por Horário</option>
                    <option value="name">Por Nome</option>
                </select>
            </div>
            <div class="month-navigation" style="margin-left: auto;">
                 <button id="prev-month-btn" title="Mês Anterior">
                    <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24"><path fill="currentColor" d="M15.41 7.41L14 6l-6 6l6 6l1.41-1.41L10.83 12z"/></svg>
                </button>
                <h2 id="current-month-year"></h2>
                <button id="next-month-btn" title="Próximo Mês">
                    <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24"><path fill="currentColor" d="M8.59 16.59L10 18l6-6l-6-6l-1.41 1.41L13.17 12z"/></svg>
                </button>
            </div>
        </div>

        <main class="bujo-main">
            <table id="habit-tracker-table">
                <thead>
                    <tr class="days-header-row"></tr>
                </thead>
                <tbody class="habit-tracker-body"></tbody>
            </table>
            <div id="no-habits-info" class="no-habits-message hidden">
                <h2>Comece sua Jornada!</h2>
                <p>Nenhum hábito rastreado ainda. Clique em "Adicionar" para criar seu primeiro hábito.</p>
            </div>
        </main>
    </div>

    <!-- Modal para Adicionar/Editar Hábito -->
    <div id="habit-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="modal-title">Adicionar Hábito</h2>
            <form id="habit-form">
                <input type="hidden" id="habit-id">
                <div class="form-group">
                    <label for="habit-name">Nome do Hábito</label>
                    <input type="text" id="habit-name" required placeholder="Ex: Ler por 30 minutos">
                </div>
                <div class="form-group">
                    <label for="habit-time">Horário (Opcional)</label>
                    <input type="time" id="habit-time">
                </div>
                <div class="form-group">
                    <label for="habit-icon">Ícone</label>
                    <input type="hidden" id="habit-icon-input" value="🎯">
                    <div id="icon-picker" class="icon-picker"></div>
                </div>
                <div class="modal-actions">
                    <button type="button" id="delete-habit-btn" class="hidden">Excluir</button>
                    <button type="button" id="cancel-habit-btn">Cancelar</button>
                    <button type="submit" id="save-habit-btn">Salvar</button>
                </div>
            </form>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Elementos do DOM ---
        const habitModal = document.getElementById('habit-modal');
        const modalTitle = document.getElementById('modal-title');
        const habitForm = document.getElementById('habit-form');
        const habitIdInput = document.getElementById('habit-id');
        const habitNameInput = document.getElementById('habit-name');
        const habitTimeInput = document.getElementById('habit-time');
        const habitIconInput = document.getElementById('habit-icon-input');
        const iconPicker = document.getElementById('icon-picker');
        const addHabitModalBtn = document.getElementById('add-habit-modal-btn');
        const cancelHabitBtn = document.getElementById('cancel-habit-btn');
        const deleteHabitBtn = document.getElementById('delete-habit-btn');
        const sortBySelect = document.getElementById('sort-by');
        const habitTrackerBody = document.querySelector('.habit-tracker-body');
        const daysHeaderRow = document.querySelector('.days-header-row');
        const noHabitsInfo = document.getElementById('no-habits-info');
        const currentMonthYearDisplay = document.getElementById('current-month-year');
        const prevMonthBtn = document.getElementById('prev-month-btn');
        const nextMonthBtn = document.getElementById('next-month-btn');
        const syncStatusText = document.getElementById('sync-status-text');
        const syncStatusIcon = document.getElementById('sync-status-icon');
        const syncStatusContainer = document.getElementById('sync-status');
        
        // --- Estado da Aplicação ---
        let habits = [];
        let currentDate = new Date();
        let currentMonth = currentDate.getMonth();
        let currentYear = currentDate.getFullYear();
        let syncTimeout;

        const THIS_PAGE_URL = window.location.href;
        const ICONS = ['🎯', '🏃', '💧', '📖', '🧘', '💻', '🎨', '🎵', '💰', '🧹', '💪', '🧠', '🌱', '☀️', '🌙', '✅'];
        const MONTH_NAMES = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
        const DAY_SHORT_NAMES = ["D", "S", "T", "Q", "Q", "S", "S"];

        // --- Funções de Sincronização e Persistência ---
        function saveToLocalStorage() {
            localStorage.setItem('bujoTrackerHabits_v2', JSON.stringify(habits));
        }

        function updateSyncStatus(status, duration = 3000) {
            clearTimeout(syncTimeout);
            syncStatusIcon.classList.remove('spinning');
            syncStatusIcon.innerHTML = `<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline>`; // Checkmark

            if (status === 'syncing') {
                syncStatusContainer.classList.add('syncing');
                syncStatusText.textContent = 'Sincronizando...';
                syncStatusIcon.classList.add('spinning');
                syncStatusIcon.innerHTML = `<line x1="12" y1="2" x2="12" y2="6"></line><line x1="12" y1="18" x2="12" y2="22"></line><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"></line><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"></line><line x1="2" y1="12" x2="6" y2="12"></line><line x1="18" y1="12" x2="22" y2="12"></line><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"></line><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"></line>`; // Loader
            } else if (status === 'synced') {
                syncStatusContainer.classList.remove('syncing');
                syncStatusText.textContent = 'Salvo na Nuvem';
                syncTimeout = setTimeout(() => {
                    syncStatusText.textContent = 'Pronto';
                }, duration);
            } else if (status === 'error') {
                 syncStatusContainer.classList.remove('syncing');
                 syncStatusText.textContent = 'Erro ao salvar';
                 syncStatusIcon.innerHTML = `<circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line>`; // Alert
            }
        }

        function syncWithParent() {
            if (window.parent && window.parent !== window) {
                updateSyncStatus('syncing');
                 window.parent.postMessage({
                    type: 'SAVE_BUJO_PAGE_DATA',
                    pageUrl: THIS_PAGE_URL,
                    payload: habits
                }, '*');
                // Assume success after a short delay, as we don't get a direct response
                setTimeout(() => updateSyncStatus('synced'), 1500);
            } else {
                console.warn('[HabitTracker] Script pai (Super Bujo) não encontrado.');
                updateSyncStatus('error');
            }
        }

        function saveAndRender() {
            sortHabits(sortBySelect.value, false); // Re-sort before saving
            saveToLocalStorage();
            syncWithParent();
            renderTracker();
        }

        // --- Funções do Modal e CRUD de Hábitos ---
        function openHabitModal(habit = null) {
            habitForm.reset();
            habitIdInput.value = habit ? habit.id : '';
            habitNameInput.value = habit ? habit.name : '';
            habitTimeInput.value = habit ? habit.time : '';
            habitIconInput.value = habit ? habit.icon : ICONS[0];
            modalTitle.textContent = habit ? 'Editar Hábito' : 'Adicionar Hábito';
            deleteHabitBtn.classList.toggle('hidden', !habit);
            renderIconPicker();
            habitModal.classList.add('open');
            habitNameInput.focus();
        }

        function closeHabitModal() {
            habitModal.classList.remove('open');
        }

        function handleFormSubmit(e) {
            e.preventDefault();
            const id = habitIdInput.value;
            const habitData = {
                name: habitNameInput.value.trim(),
                time: habitTimeInput.value,
                icon: habitIconInput.value,
            };

            if (id) { // Editando
                const index = habits.findIndex(h => h.id === id);
                if (index > -1) {
                    habits[index] = { ...habits[index], ...habitData };
                }
            } else { // Adicionando
                habits.push({
                    id: Date.now().toString(),
                    ...habitData,
                    order: habits.length,
                    progress: {}
                });
            }
            closeHabitModal();
            saveAndRender();
        }

        function handleDeleteHabit() {
            const id = habitIdInput.value;
            if (id && confirm('Tem certeza que deseja excluir este hábito permanentemente?')) {
                habits = habits.filter(h => h.id !== id);
                closeHabitModal();
                saveAndRender();
            }
        }

        // --- Funções de Renderização ---
        function renderIconPicker() {
            iconPicker.innerHTML = ICONS.map(icon =>
                `<div class="icon-option ${icon === habitIconInput.value ? 'selected' : ''}" data-icon="${icon}">${icon}</div>`
            ).join('');
        }

        function renderTracker() {
            currentMonthYearDisplay.textContent = `${MONTH_NAMES[currentMonth]} ${currentYear}`;
            renderHeader();
            renderBody();
            noHabitsInfo.classList.toggle('hidden', habits.length > 0);
            document.getElementById('habit-tracker-table').classList.toggle('hidden', habits.length === 0);
        }

        function renderHeader() {
            daysHeaderRow.innerHTML = '';
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            
            const habitNameHeader = document.createElement('th');
            habitNameHeader.className = 'habit-name-col';
            habitNameHeader.textContent = 'Hábito';
            daysHeaderRow.appendChild(habitNameHeader);

            for (let i = 1; i <= daysInMonth; i++) {
                const th = document.createElement('th');
                th.innerHTML = `${DAY_SHORT_NAMES[new Date(currentYear, currentMonth, i).getDay()]}<br>${i}`;
                daysHeaderRow.appendChild(th);
            }
        }

        function renderBody() {
            habitTrackerBody.innerHTML = '';
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const monthKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;

            habits.forEach(habit => {
                const progress = habit.progress[monthKey] || Array(daysInMonth).fill(false);
                const tr = document.createElement('tr');
                tr.className = 'habit-row';
                tr.dataset.id = habit.id;
                tr.draggable = true;

                tr.innerHTML = `
                    <td class="habit-name-cell">
                        <span class="habit-icon">${habit.icon}</span>
                        <div class="habit-info">
                            <div class="habit-name">${habit.name}</div>
                            ${habit.time ? `<div class="habit-time">${habit.time}</div>` : ''}
                        </div>
                        <div class="habit-actions">
                            <button class="edit-habit-btn" title="Editar Hábito">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                            </button>
                        </div>
                    </td>
                    ${Array.from({ length: daysInMonth }).map((_, dayIndex) => `
                        <td class="day-cell">
                            <div class="day-cell-inner ${progress[dayIndex] ? 'completed' : ''}" data-habit-id="${habit.id}" data-day-index="${dayIndex}">
                                ${progress[dayIndex] ? '✓' : ''}
                            </div>
                        </td>
                    `).join('')}
                `;
                habitTrackerBody.appendChild(tr);
            });
        }

        // --- Funções de Interação e Lógica ---
        function toggleDayCompletion(habitId, dayIndex) {
            const habit = habits.find(h => h.id === habitId);
            if (!habit) return;

            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const monthKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
            
            if (!habit.progress[monthKey]) {
                habit.progress[monthKey] = Array(daysInMonth).fill(false);
            }
            habit.progress[monthKey][dayIndex] = !habit.progress[monthKey][dayIndex];
            
            saveAndRender();
        }

        function sortHabits(sortBy, shouldRender = true) {
            switch (sortBy) {
                case 'time':
                    habits.sort((a, b) => {
                        if (!a.time && !b.time) return a.order - b.order;
                        if (!a.time) return 1;
                        if (!b.time) return -1;
                        return a.time.localeCompare(b.time);
                    });
                    break;
                case 'name':
                    habits.sort((a, b) => a.name.localeCompare(b.name));
                    break;
                case 'manual':
                default:
                    habits.sort((a, b) => a.order - b.order);
                    break;
            }
            // Update order property for manual sorting persistence
            if (sortBy !== 'manual') {
                habits.forEach((habit, index) => habit.order = index);
            }
            if (shouldRender) {
                saveAndRender();
            }
        }

        // --- Event Listeners ---
        addHabitModalBtn.addEventListener('click', () => openHabitModal());
        cancelHabitBtn.addEventListener('click', closeHabitModal);
        habitForm.addEventListener('submit', handleFormSubmit);
        deleteHabitBtn.addEventListener('click', handleDeleteHabit);
        sortBySelect.addEventListener('change', () => sortHabits(sortBySelect.value));
        
        habitModal.addEventListener('click', e => { if (e.target === habitModal) closeHabitModal(); });
        iconPicker.addEventListener('click', e => {
            if (e.target.classList.contains('icon-option')) {
                habitIconInput.value = e.target.dataset.icon;
                renderIconPicker();
            }
        });
        
        habitTrackerBody.addEventListener('click', e => {
            const dayCell = e.target.closest('.day-cell-inner');
            const editBtn = e.target.closest('.edit-habit-btn');
            
            if (dayCell) {
                toggleDayCompletion(dayCell.dataset.habitId, parseInt(dayCell.dataset.dayIndex));
            } else if (editBtn) {
                const habitId = e.target.closest('.habit-row').dataset.id;
                const habit = habits.find(h => h.id === habitId);
                if(habit) openHabitModal(habit);
            }
        });

        // Drag and Drop Logic
        let draggedElement = null;
        habitTrackerBody.addEventListener('dragstart', e => {
            draggedElement = e.target;
            e.target.classList.add('dragging');
        });
        habitTrackerBody.addEventListener('dragend', e => {
            draggedElement.classList.remove('dragging');
            draggedElement = null;
        });
        habitTrackerBody.addEventListener('dragover', e => {
            e.preventDefault();
            const target = e.target.closest('.habit-row');
            if(target && target !== draggedElement) {
                document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
                target.classList.add('drag-over');
            }
        });
        habitTrackerBody.addEventListener('dragleave', e => {
             e.target.closest('.habit-row')?.classList.remove('drag-over');
        });
        habitTrackerBody.addEventListener('drop', e => {
            e.preventDefault();
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
            const targetRow = e.target.closest('.habit-row');
            if (targetRow && draggedElement) {
                const draggedId = draggedElement.dataset.id;
                const targetId = targetRow.dataset.id;
                
                const draggedIndex = habits.findIndex(h => h.id === draggedId);
                const targetIndex = habits.findIndex(h => h.id === targetId);
                
                const [draggedItem] = habits.splice(draggedIndex, 1);
                habits.splice(targetIndex, 0, draggedItem);
                
                habits.forEach((habit, index) => habit.order = index);
                sortBySelect.value = 'manual';
                saveAndRender();
            }
        });

        prevMonthBtn.addEventListener('click', () => {
            currentMonth--; if (currentMonth < 0) { currentMonth = 11; currentYear--; } renderTracker();
        });
        nextMonthBtn.addEventListener('click', () => {
            currentMonth++; if (currentMonth > 11) { currentMonth = 0; currentYear++; } renderTracker();
        });

        // Listener para dados do script pai (Super Bujo)
        window.addEventListener('message', event => {
            if (event.data && event.data.type === 'BUJO_PAGE_DATA_LOADED' && event.data.pageUrl === THIS_PAGE_URL) {
                const cloudHabits = event.data.payload;
                if (cloudHabits && Array.isArray(cloudHabits) && JSON.stringify(cloudHabits) !== JSON.stringify(habits)) {
                    console.log('[HabitTracker] Recebendo dados da nuvem. Atualizando localmente.');
                    habits = cloudHabits;
                    saveToLocalStorage();
                    renderTracker();
                    updateSyncStatus('synced', 1000);
                } else if (!cloudHabits && habits.length > 0) {
                     console.log('[HabitTracker] Nuvem vazia, mas local tem dados. Enviando para a nuvem.');
                     syncWithParent();
                }
            }
        });
        
        // --- Inicialização ---
        function initialize() {
            const localData = localStorage.getItem('bujoTrackerHabits_v2');
            habits = localData ? JSON.parse(localData) : [];
            // Assegurar que dados antigos tenham a propriedade 'order'
            habits.forEach((h, i) => { if (h.order === undefined) h.order = i; });

            sortHabits(sortBySelect.value); // Ordena e renderiza

            // Solicitar dados do pai
            if (window.parent && window.parent !== window) {
                window.parent.postMessage({ type: 'REQUEST_BUJO_PAGE_DATA', pageUrl: THIS_PAGE_URL }, '*');
            }
        }
        
        initialize();
    });
    </script>
</body>
</html>
